<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"],input[type="text"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal {
  width: 100%;
  max-width: 760px;
  background: white;
  padding: 16px;
  border-radius: 12px;
  max-height: 90vh;   /* keeps modal inside viewport */
  overflow-y: auto;   /* allows vertical scrolling */
}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;margin-bottom:6px}
.ticket.winner{background:gold}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
select option[disabled]{ color: #999; }

/* Item Retrieved button states */
.itemRetrievedBtn.disabled{background:#ccc;color:#666;cursor:not-allowed;border-radius:8px;padding:8px 12px}
.itemRetrievedBtn.enabled{background:green;color:#fff;cursor:pointer;border-radius:8px;padding:8px 12px}

/* WINNER button */
.winnerBtn{background:gold;color:#111;cursor:pointer;border-radius:8px;padding:8px 12px;margin-left:8px}
</style>
</head>
<body>
<div id="loginModal" class="modal-back">
  <div class="modal">
    <h3>Login</h3>
    <div style="margin-bottom:12px">
      <label>Enter your login code or Create Account if new: <input type="text" id="loginCode"></label>
      <div class="loginNotice">(Login codes are case-sensitive. Ensure the 'user' part is lowercase. EX: user-123abc)</div>
    </div>
    <div style="margin-bottom:12px">or <button class="btn" id="createCodeBtn">Create new code</button></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" id="loginBtn">Login</button>
    </div>
    <div style="margin-top:8px;display:flex;justify-content:flex-end">
      <button class="btn ghost" id="aboutLoginBtn">About Easy Green</button>
    </div>
  </div>
</div>

<div id="warningModal" class="modal-back hidden">
  <div class="modal">
    <h3>Warnings & Rules</h3>
    <ul>
      <li>Easy Green is not liable for any stolen Product/Payments.</li>
      <li>Use products safely.</li>
      <li>Respect site anonymity.</li>
    </ul>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="ackCheck"> I agree </label>
      <button class="btn" id="ackBtn">Confirm</button>
    </div>
  </div>
</div>

<div id="helpModal" class="modal-back hidden">
  <div class="modal">
    <h3>First Time Help</h3>
    <p>Welcome to Easy Green! Here's how it works:</p>
    <ol>
      <li>Select products and flavors you want.</li>
      <li>Add items to your cart and choose pickup location.</li>
      <li>Click Purchase to generate a ticket for your order.</li>
      <li>Use the chat under your ticket to send messages or images to admin.</li>
      <li>Admin can respond and send images back.</li>
      <li>Place the specified cash amount in an Envelope and hide it at your selected location.</li>
      <li>Click the "Mark as paid" button, and send a photo of your envelope and the cash inside, along with details about it's hiding spot.</li>
      <li>Admin will message you with product retrieval details after your payment is collected.</li>
      <li>TIPS: It is recommended to hide payments out of the publics view and way, and ensure nobody sees you hiding your payment.</li>
    </ol>
    <button class="btn" id="closeHelp">Got it!</button>
  </div>
</div>

<div id="aboutModal" class="modal-back hidden">
  <div class="modal">
    <h3>About Easy Green</h3>
    <p> Welcome to Easy Green! We are proud to be the only local Cannabis service that is fully anonymous. If you wish to obtain cannabis discreetly‚Äîwithout meeting a random sketchy dealer in person, or if you do not have access to a nearby dispensary‚ÄîEasy Green is here for you. Simply select a pickup location nearest to you and enjoy our secure and simple exchange process. We are based in Arlington Heights and proudly serve anyone in or near the area. Take advantage of our exceptional deals and competitive pricing, as we believe everyone should have access to quality cannabis regardless of budget. We are continually expanding our product selection and pickup locations, and will soon offer additional items beyond cannabis. Enjoy Easy Green, and please consider sharing our website! </p>
    <button class="btn" id="closeAbout">Close</button>
  </div>
</div>

<div id="faqModal" class="modal-back hidden">
  <div class="modal">
    <h3>FAQ</h3>
    <div class="faq-list">
      <h4>Q: How do I place an order?</h4>
      <p>A: Simply add products to your cart, select a pickup location, and click ‚ÄúPurchase.‚Äù</p>

      <h4>Q: What photos should I take when hiding my payment?</h4>
      <p>A: In order for your admin to accept your ticket, you must hide your payment, click the mark paid button, and then include a clear photo of all of the bills, and the exact hiding spot the envelope is in (with the envelope in the picture) </p>

      <h4>Q: How do referrals work?</h4>
      <p>A: After retrieving an item, if you enter a valid referral code, both you and your friend earn raffle tickets.</p>

      <h4>Q: How does the raffle work?</h4>
      <p>A: At the end of every month, we will select 1 winner to win a free item. If you win, you will see a special golden chat ticket appear in your account.</p>

      <h4>Q: What payment is accepted?</h4>
      <p>A: Easy Green accepts cash only for now, but look forward to Bitcoin being a payment method in the future, which would completely eliminate the need to hide any payment.</p>

      <h4>Q: Are these products safe?</h4>
      <p>A: Absolutely! Easy Green has meticulously tested each product to ensure safety and purity.</p>

      <h4>Q: Where should I hide my payments?</h4>
      <p>A: It is highly recommended to hide your payment in areas such as bushes, under trash cans, under porta pottys, and other spots out of the publics sight. Be creative, and have fun with it!</p>

      <h4>Q: I only have big bills, does Easy Green give change?</h4>
      <p>A: While change cannot be guaranteed, it is worth messaging your admin in your chat ticket to see if they have the available change on hand. If they do, they will just simply hide the owed change with the product.</p>


    </div>
    <button class="btn" id="closeFaq">Close</button>
  </div>
</div>

<div class="wrap hidden" id="mainWrap">
  <header>
    <h1>Easy Green ‚Äî Anonymous Cannabis</h1>
    <button class="btn ghost" id="logoutBtn" style="margin-left:auto">Log Out</button>
  </header>

  <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
    <div class="small" style="white-space:nowrap; overflow-x:auto; max-width:200px;">
  (WRITE THIS DOWN) Your account code: <span id="acctCode"></span>
</div>
    <div class="small" style="margin-left:12px">Your referral code: <span id="refCode">--</span></div>
    <div class="small" style="margin-left:12px">You have <span id="ticketCount">0</span> raffle tickets</div>
    <button class="btn" id="helpBtn" style="margin-left:auto">First time help</button>
    <button class="btn ghost" id="aboutUserBtn">About Easy Green</button>
    <button class="btn ghost" id="faqBtn">FAQ</button>
  </div>

  <div class="grid" role="main">
    <section class="card">
      <h2>Products</h2>
      <div class="products" id="productsGrid"></div>
    </section>

    <aside class="card">
      <h2>Cart & Pickup</h2>
      <div>
        <label class="small">Pickup Location</label>
        <select id="locationSelect">
          <option value="Hasbrook Park">Hasbrook Park</option>
          <option value="Virginia Terrace Park">Virginia Terrace Park</option>
          <option value="Frontier Park">Frontier Park</option>
          <option value="Pioneer Park">Pioneer Park</option>
          <option value="Grealish Park">Grealish Park</option>
          <option value="Happiness Park">Happiness Park</option>
          <option value="Greenbrier Park">Greenbrier Park</option>
          <option value="Kimball Hill Park">Kimball Hill Park</option>
          <option value="Centennial Park">Centennial Park</option>
          <option value="Olive School (Weekends only)">Olive School (Weekends only)</option>
          <option value="Patton School (Weekends only)">Patton School (Weekends only)</option>
          <option value="Ivy Hill School (Weekends only)">Ivy Hill School (Weekends only)</option>
        </select>
      </div>

      <div style="margin-top:12px">
        <div id="cartList"></div>
        <div class="cart-total small" id="cartTotal"></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="purchaseBtn">Purchase</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
      </div>

      <div style="margin-top:12px">
        <div class="small">Tickets </div>
        <div id="ticketsArea" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>

  <footer> Easy Green only accepts cash payments. </footer>
</div>

<div id="adminScreen">
  <h2>Admin Console</h2>
  <div style="margin-bottom:12px">
    <button class="btn" id="refreshTickets">Refresh Tickets</button>
    <button class="btn ghost" id="closeAdmin">Close Admin</button>
    <button class="winnerBtn" id="raffleWinnerBtn">WINNER</button>
  </div>
  <h3>All Tickets</h3>
  <div id="allTicketsArea"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA1JdHEgkIQKzX_FKZKNgLW6YEqAqMiRDo",
  authDomain: "easy-green-website.firebaseapp.com",
  databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com",
  projectId: "easy-green-website",
  storageBucket: "easy-green-website.firebasestorage.app",
  messagingSenderId: "988776675269",
  appId: "1:988776675269:web:f2245f84a726d01f3e3dac",
  measurementId: "G-PR35QWS2T6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- Admin Password Modal ---------- */
function showAdminPasswordModal(onSuccess) {
  const modalBack = document.createElement('div');
  modalBack.className = 'modal-back';
  modalBack.innerHTML = `
    <div class="modal">
      <h3>Enter Admin Password</h3>
      <input type="password" id="adminPasswordInput" placeholder="Password" style="width:100%;margin-top:8px;padding:6px;border-radius:8px;border:1px solid #ddd">
      <div id="adminPassError" style="color:red;font-size:.85rem;margin-top:6px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn" id="submitAdminPass">Submit</button>
        <button class="btn ghost" id="cancelAdminPass">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalBack);

  modalBack.querySelector('#cancelAdminPass').onclick = () => modalBack.remove();

  modalBack.querySelector('#submitAdminPass').onclick = async () => {
    const input = modalBack.querySelector('#adminPasswordInput').value.trim();
    const errorDiv = modalBack.querySelector('#adminPassError');
    if(!input) return errorDiv.innerText = 'Enter password';

    try {
      const snap = await db.ref('adminPassword').once('value');
      const correctPassword = snap.val();
      if(input === correctPassword){
        modalBack.remove();
        onSuccess();
      } else {
        errorDiv.innerText = 'Incorrect password';
      }
    } catch(err){
      console.error('Error checking admin password', err);
      errorDiv.innerText = 'Error checking password';
    }
  };
}
</script>



</script>

<script>
/* ---------- state ---------- */
let currentUser = null;
let currentUserIsAdmin = false;
let cart = [];
let userRefCode = null;

/* ---------- utils ---------- */
function generateReferralCode() {
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const letter = letters[Math.floor(Math.random() * letters.length)];
  const number = Math.floor(10000 + Math.random() * 90000);
  return letter + number;
}

function updateReferralUI() {
  document.getElementById('refCode').innerText = userRefCode || '--';
}

function updateTicketCountUI() {
  if(!currentUser) return;
  db.ref('raffleTickets').orderByChild('owner').equalTo(currentUser).on('value', snap => {
    const tickets = snap.val() || {};
    const count = Object.keys(tickets).length;
    document.getElementById('ticketCount').innerText = count;
  });
}

/* ---------- account creation & login ---------- */
document.getElementById('createCodeBtn').onclick = () => {
  const code = 'user-' + Math.random().toString(36).substr(2,6);
  const refCode = generateReferralCode();
  db.ref('users/' + code).set({created:Date.now(), referralCode: refCode});
  alert('Your code: ' + code);
  document.getElementById('loginCode').value = code;
};

document.getElementById('loginBtn').onclick = () => {
  const code = document.getElementById('loginCode').value.trim();
  if(!code) return alert('Enter a code');
  db.ref('users/' + code).once('value').then(snapshot => {
    const user = snapshot.val();
    if(!user) return alert('Invalid code');
    currentUser = code;
if(code === 'user-9e21mr'){
  // Show password prompt first
  showAdminPasswordModal(() => {
    currentUserIsAdmin = true;
    document.getElementById('adminScreen').style.display = 'block';
    document.getElementById('warningModal').classList.add('hidden');
    updateTicketCountUI();
    renderTickets();
  });
} else {
  currentUserIsAdmin = false;
}

    document.getElementById('acctCode').innerText = code;
    // Load referral code (create if missing)
    if(!user.referralCode){
      userRefCode = generateReferralCode();
      db.ref('users/' + code + '/referralCode').set(userRefCode);
    } else {
      userRefCode = user.referralCode;
    }
    updateReferralUI();
    // Hide login modal
    document.getElementById('loginModal').classList.add('hidden');
    if(currentUserIsAdmin) {
      document.getElementById('adminScreen').style.display = 'block';
    }
    // Show warning modal only for non-admins
    document.getElementById('warningModal').classList.toggle('hidden', currentUserIsAdmin);
    updateTicketCountUI();
    renderTickets();
  }).catch(err=>{
    console.error('Login error', err);
    alert('Login error');
  });
};

/* ---------- warning modal / main display ---------- */
document.getElementById('ackBtn').onclick = () => {
  if(!document.getElementById('ackCheck').checked) return alert('Check agree');
  document.getElementById('warningModal').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
  renderTickets();
  renderProducts();
};

/* ---------- small UI bindings ---------- */
document.getElementById('closeHelp').onclick = () => document.getElementById('helpModal').classList.add('hidden');
document.getElementById('helpBtn').onclick = () => document.getElementById('helpModal').classList.remove('hidden');
document.getElementById('logoutBtn').onclick = () => location.reload();
document.getElementById('clearBtn').onclick = () => { cart=[]; renderCart(); };
document.getElementById('aboutLoginBtn').onclick = () => document.getElementById('aboutModal').classList.remove('hidden');
document.getElementById('aboutUserBtn').onclick = () => document.getElementById('aboutModal').classList.remove('hidden');
document.getElementById('closeAbout').onclick = () => document.getElementById('aboutModal').classList.add('hidden');
document.getElementById('faqBtn').onclick = () => 
  document.getElementById('faqModal').classList.remove('hidden');
document.getElementById('closeFaq').onclick = () => 
  document.getElementById('faqModal').classList.add('hidden');


/* ---------- STOCK & PRODUCTS ---------- */
/*
Stock node supports:
  stock/<productId> = "out" OR "in"  (product-level)
  stock/<productId>/<flavorName> = "out" or "in" (flavor-level)
*/
let cachedStock = {};
db.ref('stock').on('value', snap => {
  cachedStock = snap.val() || {};
  // If main UI is visible, re-render products to update disabled states
  if(!document.getElementById('mainWrap').classList.contains('hidden')) renderProducts();
});

function renderProducts() {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';
  // sample data (you can keep it; stock will override availability)
  const sample = [
    {id:'bud1',name:'Edibles (Buy 3 get 1 free)',price:20,flavors:['Sour Patch','Skittles','Swedish fish','Starburst','Trolli','Peach Rings']},
    {id:'cart1',name:'2g Muha Meds Carts (Buy 1 get 1 $5 off)',price:30,flavors:['Indica','Satavia','Hybrid']}
  ];

  sample.forEach(p => {
    const div = document.createElement('div');
    div.className='product';
    const title = document.createElement('h3'); title.textContent = p.name;
    const priceDiv = document.createElement('div'); priceDiv.textContent = '$' + p.price;
    const select = document.createElement('select');
    const defOpt = document.createElement('option'); defOpt.value=''; defOpt.textContent='Select Flavor'; select.appendChild(defOpt);

    // Determine product-level stock
    const productStock = (cachedStock && cachedStock[p.id]) ? cachedStock[p.id] : null;

    p.flavors.forEach(f=>{
      const option = document.createElement('option');
      option.value = f;
      option.textContent = f;
      // If productStock is a string 'out', disable all options
      if(typeof productStock === 'string' && productStock.toLowerCase() === 'out'){
        option.disabled = true;
        option.style.color = '#999';
      } else if(productStock && typeof productStock === 'object'){
        // flavor-level stock
        const flavorState = productStock[f];
        if(flavorState && String(flavorState).toLowerCase() === 'out'){
          option.disabled = true;
          option.style.color = '#999';
        }
      }
      select.appendChild(option);
    });

    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Add';
    // disable Add if product-level out
    if(typeof productStock === 'string' && productStock.toLowerCase() === 'out'){
      btn.disabled = true;
      btn.title = 'Out of stock';
      btn.style.opacity = 0.6;
    }
    btn.onclick = ()=>{
      if(btn.disabled) return alert('Item out of stock');
      const flavor = select.value || '';
      // If user hasn't selected flavor
      if(!flavor) return alert('Select a flavor');
      // If the selected option is disabled, don't allow adding
      const opt = Array.from(select.options).find(o=>o.value===flavor);
      if(opt && opt.disabled) return alert('Selected flavor is out of stock');
      cart.push({...p,selectedFlavor:flavor});
      renderCart();
    };

    div.appendChild(title);
    div.appendChild(priceDiv);
    div.appendChild(select);
    div.appendChild(btn);
    grid.appendChild(div);
  });
}

/* ---------- CART ---------- */
function renderCart() {
  const list = document.getElementById('cartList');
  list.innerHTML = '';
  let total = 0, ediblesCount = 0, muhaCount = 0;
  cart.forEach((c, idx) => {
    if(c.name.includes('Edibles')) ediblesCount++;
    if(c.name.includes('Muha Meds')) muhaCount++;
    total += c.price;
  });
  total -= Math.floor(ediblesCount/4)*20;
  total -= Math.floor(muhaCount/2)*5;

  cart.forEach((c, i) => {
    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerHTML = `<span>${c.name} (${c.selectedFlavor})</span><span>$${c.price}</span>`;
    const rem = document.createElement('button'); rem.className = 'btn ghost'; rem.textContent = 'X';
    rem.onclick = ()=>{ cart.splice(i,1); renderCart(); };
    row.appendChild(rem);
    list.appendChild(row);
  });

  document.getElementById('cartTotal').innerText = 'Total $' + total;
}

/* ---------- PURCHASE (create ticket) ---------- */
/* Note: raffleTickets are NOT granted at purchase anymore.
   They are granted when the user clicks Item Retrieved and finishes referral flow.
*/
document.getElementById('purchaseBtn').onclick = () => {
  if(!cart.length) return alert('Empty cart');
  const ticketId = 'tkt-' + Date.now();
  let total = 0, ediblesCount = 0, muhaCount = 0;
  cart.forEach(c=>{ total+=c.price; if(c.name.includes('Edibles')) ediblesCount++; if(c.name.includes('Muha Meds')) muhaCount++; });
  total -= Math.floor(ediblesCount/4)*20;
  total -= Math.floor(muhaCount/2)*5;
  const ticket = {
    id: ticketId,
    total: total,
    location: document.getElementById('locationSelect').value,
    status: 'pending',
    items: cart,
    user: currentUser
  };
  db.ref('tickets/' + ticketId).set(ticket);
  db.ref('messages/' + ticketId).push({from: currentUser, text: 'Ticket created'});
  // NOTE: no raffleTickets push here
  cart = [];
  renderCart();
  renderTickets();
};

/* ---------- Item Retrieved modal & referral flow ---------- */
function showItemRetrievedModal(ticketId){
  const modalBack = document.createElement('div');
  modalBack.className = 'modal-back';
  modalBack.style.zIndex = 2000;
  modalBack.innerHTML = `
    <div class="modal">
      <h3>Item Received</h3>
      <p>Did a friend refer you?</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="yesReferralBtn">Yes</button>
        <button class="btn ghost" id="noReferralBtn">No</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalBack);

  modalBack.querySelector('#noReferralBtn').onclick = () => {
    // give the user their raffle ticket then remove ticket
    if(currentUser){
      db.ref('raffleTickets').push().set({owner: currentUser, code: userRefCode, reason:'finalize'});
    }
    // remove ticket and messages so it disappears
    db.ref('tickets/'+ticketId).remove();
    db.ref('messages/'+ticketId).remove();
    modalBack.remove();
  };

  modalBack.querySelector('#yesReferralBtn').onclick = () => {
    const entryDiv = document.createElement('div');
    entryDiv.style.marginTop = '12px';
    entryDiv.innerHTML = `
      <label>Enter referral code: <input type="text" id="friendCode"></label>
      <div id="refWarning" style="color:red;font-size:0.85rem;margin-top:6px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        <button class="btn" id="submitReferral">Submit</button>
        <button class="btn ghost" id="cancelReferral">Cancel</button>
      </div>
    `;
    modalBack.querySelector('.modal').appendChild(entryDiv);

    modalBack.querySelector('#cancelReferral').onclick = () => modalBack.remove();

    modalBack.querySelector('#submitReferral').onclick = async () => {
      const codeInput = modalBack.querySelector('#friendCode').value.trim();
      const warning = modalBack.querySelector('#refWarning');
      if(!codeInput) return warning.innerText = 'Enter a code';
      if(codeInput === userRefCode) return warning.innerText = 'You cannot use your own code';

      try {
        const snap = await db.ref('users').orderByChild('referralCode').equalTo(codeInput).once('value');
        const users = snap.val() || {};
        const userIds = Object.keys(users);
        if(userIds.length === 0){
          return warning.innerText = 'Referral code not found';
        }
        const friendAccount = userIds[0]; // first match
        // Give friend a raffle ticket (owner = friend's account)
        db.ref('raffleTickets').push().set({owner: friendAccount, code: codeInput, referredBy: currentUser});
        // Give current user their own raffle ticket
        if(currentUser){
          db.ref('raffleTickets').push().set({owner: currentUser, code: userRefCode, reason:'finalize'});
        }
        // remove the ticket and messages so it disappears
        db.ref('tickets/'+ticketId).remove();
        db.ref('messages/'+ticketId).remove();
        modalBack.remove();
      } catch(err){
        console.error('Referral lookup error', err);
        warning.innerText = 'Error validating code';
      }
    };
  };
}

/* ---------- Render tickets & chat ---------- */
function renderTickets(){
  const area = document.getElementById(currentUserIsAdmin ? 'allTicketsArea' : 'ticketsArea');
  area.innerHTML = '';
  // Listen for tickets (child_added will fire for existing children on first attach)
  db.ref('tickets').off(); // detach previous listeners to avoid dupes
  db.ref('tickets').on('child_added', snap => {
    const t = snap.val() || {};
    t.id = t.id || snap.key;
    t.user = t.user || '';
    // For non-admins, only show user's tickets
    if(!currentUserIsAdmin && t.user !== currentUser) return;

    const itemsText = (t.items || []).map(i => `${i.name} (${i.selectedFlavor})`).join(', ');
    const div = document.createElement('div');
    div.className = 'ticket';
    // mark winner ticket visually
    if(t.status === 'winner' || t.location === 'RAFFLE' || String(t.id).startsWith('raffle-')) {
      div.classList.add('winner');
    }

    div.innerHTML = `
      <div><strong>${t.id}</strong> @ ${t.location || ''} | Total $${t.total || 0} | Status ${t.status || ''}</div>
      <div><em>Items: ${itemsText}</em></div>
      <div id="chat-${t.id}" style="height:120px;overflow:auto;border-top:1px dashed #ddd;margin-top:6px;padding-top:6px"></div>
      <div style="display:flex;gap:6px;margin-top:6px">
        <input type="text" class="msgInput" style="flex:1">
        <input type="file" class="imgInput">
        <button class="btn sendBtn">Send</button>
        <button class="btn ghost cancelTicketBtn">Cancel Ticket</button>
        <button class="btn ghost markPaidBtn">Mark Paid</button>
        ${currentUserIsAdmin?'<button class="btn ghost completeOrderBtn">Complete Order</button><button class="btn ghost itemHiddenBtn">Item Hidden</button>':''}
        ${!currentUserIsAdmin?'<button class="itemRetrievedBtn disabled">Item Retrieved</button>':''}
      </div>
    `;
    area.appendChild(div);

    // Chat stream
    const chatEl = document.getElementById('chat-' + t.id);
    db.ref('messages/' + t.id).off();
    db.ref('messages/' + t.id).on('value', ms => {
      const msgs = ms.val() || {};
      chatEl.innerHTML = Object.values(msgs).map(m=>{
  const displayName = (m.from === 'user-9e21mr' && currentUser !== 'user-9e21mr') ? 'admin' : m.from;

  // Use the message timestamp if it exists, otherwise Date.now()
  const time = m.timestamp || Date.now();
  // Convert to CST (UTC-6)
  const date = new Date(time);
  const cstTime = new Date(date.getTime() - 6*60*60*1000); 
  const hours = cstTime.getHours().toString().padStart(2,'0');
  const minutes = cstTime.getMinutes().toString().padStart(2,'0');
  const timestamp = `${hours}:${minutes} CST`;

let timeStr = '';
if(m.timestamp){
  const d = new Date(m.timestamp);
  let hours = d.getHours();
  const minutes = d.getMinutes().toString().padStart(2,'0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  if(hours === 0) hours = 12;
  timeStr = ` (${hours}:${minutes} ${ampm})`;
}
return `<div><strong>${displayName}:</strong> ${m.text || ''}${m.image ? '<br><img src="'+m.image+'" style="max-width:160px;margin-top:4px">' : ''}${timeStr}</div>`;

}).join('');

      chatEl.scrollTop = chatEl.scrollHeight;
    });

    // Send button
    div.querySelector('.sendBtn').onclick = () => {
      const inp = div.querySelector('.msgInput');
      const fileInp = div.querySelector('.imgInput');
      const txt = inp.value.trim();
      if(fileInp.files.length > 0){
        const file = fileInp.files[0];
        const reader = new FileReader();
       reader.onload = function(e){
  db.ref('messages/' + t.id).push({from: currentUser, image: e.target.result, timestamp: Date.now()});
};

        reader.readAsDataURL(file);
        fileInp.value = '';
      }
  if(txt) db.ref('messages/' + t.id).push({from: currentUser, text: txt, timestamp: Date.now()});

      inp.value = '';
    };

    // Cancel ticket
    div.querySelector('.cancelTicketBtn').onclick = () => {
      if(confirm('Are you sure you want to cancel this ticket?')){
        db.ref('tickets/' + t.id).remove();
        db.ref('messages/' + t.id).remove();
        div.remove();
      }
    };

    // Mark paid
    div.querySelector('.markPaidBtn').onclick = () => {
      db.ref('messages/' + t.id).push({from: currentUser, text:'Payment hidden. Your product will be securely hidden within 24 hours.'});
      db.ref('tickets/' + t.id + '/status').set('paid');
    };

    // Admin actions: completeOrder & itemHidden
    if(currentUserIsAdmin){
      const completeBtn = div.querySelector('.completeOrderBtn');
      const itemHiddenBtn = div.querySelector('.itemHiddenBtn');
      if(completeBtn){
        completeBtn.onclick = () => {
          db.ref('tickets/' + t.id + '/readyForReceived').set(true);
          db.ref('tickets/' + t.id + '/status').set('ready_for_retrieval');
          db.ref('messages/' + t.id).push({from: currentUser, text: "Admin has hidden your product. Once you retrieve it, please click the 'Item Retrieved' button to finalize your order."});
        };
      }
      if(itemHiddenBtn){
        itemHiddenBtn.onclick = () => {
          db.ref('tickets/' + t.id + '/status').set('item hidden');
          alert('Marked item hidden/collected');
        };
      }
    }

    // User: Item Retrieved enabling & click
    if(!currentUserIsAdmin){
      const itemBtn = div.querySelector('.itemRetrievedBtn');
      itemBtn.classList.add('disabled');
      itemBtn.disabled = true;
      const readyRef = db.ref('tickets/' + t.id + '/readyForReceived');
      readyRef.on('value', snap => {
        const val = snap.val();
        if(val){
          itemBtn.classList.remove('disabled'); itemBtn.classList.add('enabled'); itemBtn.disabled = false;
          itemBtn.onclick = () => showItemRetrievedModal(t.id);
        } else {
          itemBtn.classList.remove('enabled'); itemBtn.classList.add('disabled'); itemBtn.disabled = true;
        }
      });
    }
  });

  // Also listen for ticket removals/changes so UI can refresh if needed
  db.ref('tickets').off('child_removed');
  db.ref('tickets').on('child_removed', snap => {
    // re-render area simply to keep consistent
    setTimeout(()=>renderTickets(), 150);
  });
}

/* ---------- Admin: create RAFFLE WINNER ticket modal ---------- */
document.getElementById('raffleWinnerBtn').onclick = () => {
  if(!currentUserIsAdmin) return alert('Only admin can create winner tickets');
  // modal
  const modalBack = document.createElement('div');
  modalBack.className = 'modal-back';
  modalBack.style.zIndex = 2500;
  modalBack.innerHTML = `
    <div class="modal">
      <h3>Create Raffle Winner Ticket</h3>
      <div style="margin-top:8px">
        <label>Enter user account code (e.g. user-abc123): <input type="text" id="winnerUserCode" style="width:100%"></label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="submitWinnerBtn">Create</button>
        <button class="btn ghost" id="closeWinnerModal">Close</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalBack);
  modalBack.querySelector('#closeWinnerModal').onclick = () => modalBack.remove();
  modalBack.querySelector('#submitWinnerBtn').onclick = async () => {
    const code = modalBack.querySelector('#winnerUserCode').value.trim();
    if(!code) return alert('Enter a user code');
    // Optionally, you could verify the user exists. We'll still create the ticket either way.
    const ticketId = 'raffle-' + Date.now();
    const ticket = { id: ticketId, total: 0, location: 'RAFFLE', status: 'winner', items: [], user: code };
    await db.ref('tickets/' + ticketId).set(ticket);
    await db.ref('messages/' + ticketId).push({ from: currentUser, text: 'RAFFLE WINNER! You have won the raffle.'});
    alert('Raffle winner ticket created for ' + code);
    modalBack.remove();
  };
};

/* ---------- admin smaller buttons ---------- */
document.getElementById('refreshTickets').onclick = () => renderTickets();
document.getElementById('closeAdmin').onclick = () => { document.getElementById('adminScreen').style.display = 'none'; };

/* ---------- initial render ---------- */
renderProducts();
  /* ---------- RAFFLE WINNER BUTTON ---------- */
document.getElementById('raffleWinnerBtn').onclick = () => {
  // popup modal
  const modalBack = document.createElement('div');
  modalBack.className = 'modal-back';
  modalBack.style.zIndex = 4000;
  modalBack.innerHTML = `
    <div class="modal">
      <h3>Declare Raffle Winner</h3>
      <label>Enter User Code: <input type="text" id="winnerCodeInput" placeholder="user-abc123"></label>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" id="cancelWinner">Cancel</button>
        <button class="btn" id="confirmWinner">Confirm</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalBack);

  modalBack.querySelector('#cancelWinner').onclick = () => modalBack.remove();

  modalBack.querySelector('#confirmWinner').onclick = () => {
    const code = modalBack.querySelector('#winnerCodeInput').value.trim();
    if(!code) return alert('Enter a user code');
    db.ref('users/' + code).once('value').then(snap => {
      if(!snap.exists()){
        alert('User not found');
        return;
      }
      // create a golden ticket
      const ticketId = 'raffle-' + Date.now();
      const ticket = {
        id: ticketId,
        total: 0,
        location: 'RAFFLE',
        status: 'winner',
        items: [],
        user: code
      };
      db.ref('tickets/' + ticketId).set(ticket);
      db.ref('messages/' + ticketId).push({
        from: 'user-9e21mr',
        text: 'üéâ Congratulations! You are the RAFFLE WINNER!'
      });
      alert('Winner ticket created for ' + code);
      modalBack.remove();
    });
  };
};

</script>
</body>
</html>
