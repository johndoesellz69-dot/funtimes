<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"],input[type="text"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{width:100%;max-width:760px;background:white;padding:16px;border-radius:12px}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;margin-bottom:6px}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
select option[disabled]{ color: #999; }

/* Item Retrieved button states */
.itemRetrievedBtn.disabled{background:#ccc;color:#666;cursor:not-allowed;border-radius:8px;padding:8px 12px}
.itemRetrievedBtn.enabled{background:green;color:#fff;cursor:pointer;border-radius:8px;padding:8px 12px}

/* WINNER button */
.winnerBtn{background:gold;color:#111;cursor:pointer;border-radius:8px;padding:8px 12px;margin-top:4px}
</style>
</head>
<body>
<div id="loginModal" class="modal-back">
<div class="modal">
<h3>Login</h3>
<div style="margin-bottom:12px">
<label>Enter your login code or Create Account if new: <input type="text" id="loginCode"></label>
<div class="loginNotice">(Login codes are case-sensitive. EX: user-123abc)</div>
</div>
<div style="margin-bottom:12px">or <button class="btn" id="createCodeBtn">Create new code</button></div>
<div style="display:flex;justify-content:flex-end;gap:8px">
<button class="btn" id="loginBtn">Login</button>
</div>
<div style="margin-top:8px;display:flex;justify-content:flex-end">
<button class="btn ghost" id="aboutLoginBtn">About Easy Green</button>
</div>
</div>
</div>

<div id="warningModal" class="modal-back hidden">
<div class="modal">
<h3>Warnings & Rules</h3>
<ul>
<li>Easy Green is not liable for any stolen Product/Payments.</li>
<li>Use products safely.</li>
<li>Respect site anonymity.</li>
</ul>
<div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
<label style="display:flex;align-items:center;gap:8px">
<input type="checkbox" id="ackCheck"> I agree </label>
<button class="btn" id="ackBtn">Confirm</button>
</div>
</div>
</div>

<div class="wrap hidden" id="mainWrap">
<header>
<h1>Easy Green â€” Anonymous Cannabis</h1>
<button class="btn ghost" id="logoutBtn" style="margin-left:auto">Log Out</button>
</header>

<div style="display:flex;gap:8px;align-items:center;margin-top:12px">
<div class="small">(Write this down) Your account code: <span id="acctCode"></span></div>
<div class="small" style="margin-left:12px">Your referral code: <span id="refCode">--</span></div>
<div class="small" style="margin-left:12px">You have <span id="ticketCount">0</span> tickets</div>
</div>

<div class="grid" role="main">
<section class="card">
<h2>Products</h2>
<div class="products" id="productsGrid"></div>
</section>

<aside class="card">
<h2>Cart & Pickup</h2>
<div>
<label class="small">Pickup Location</label>
<select id="locationSelect">
<option value="Hasbrook Park">Hasbrook Park</option>
<option value="Virginia Terrace Park">Virginia Terrace Park</option>
<option value="Frontier Park">Frontier Park</option>
<option value="Pioneer Park">Pioneer Park</option>
<option value="Grealish Park">Grealish Park</option>
<option value="Happiness Park">Happiness Park</option>
<option value="Greenbrier Park">Greenbrier Park</option>
<option value="Kimball Hill Park">Kimball Hill Park</option>
<option value="Centennial Park">Centennial Park</option>
</select>
</div>

<div style="margin-top:12px">
<div id="cartList"></div>
<div class="cart-total small" id="cartTotal"></div>
</div>

<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn" id="purchaseBtn">Purchase</button>
<button class="btn ghost" id="clearBtn">Clear</button>
</div>

<div style="margin-top:12px">
<div class="small">Tickets </div>
<div id="ticketsArea" style="margin-top:8px"></div>
</div>
</aside>
</div>

<footer> Easy Green only accepts cash payments. </footer>
</div>

<div id="adminScreen">
<h2>Admin Console</h2>
<div style="margin-bottom:12px">
<button class="btn" id="refreshTickets">Refresh Tickets</button>
<button class="btn ghost" id="closeAdmin">Close Admin</button>
<button class="winnerBtn" id="winnerBtn">Create WINNER Ticket</button>
</div>
<h3>All Tickets</h3>
<div id="allTicketsArea"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA1JdHEgkIQKzX_FKZKNgLW6YEqAqMiRDo",
  authDomain: "easy-green-website.firebaseapp.com",
  databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com",
  projectId: "easy-green-website",
  storageBucket: "easy-green-website.firebasestorage.app",
  messagingSenderId: "988776675269",
  appId: "1:988776675269:web:f2245f84a726d01f3e3dac",
  measurementId: "G-PR35QWS2T6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser=null,currentUserIsAdmin=false,cart=[],userRefCode=null;

// generate referral code
function generateReferralCode(){const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';const letter=letters[Math.floor(Math.random()*letters.length)];const number=Math.floor(10000+Math.random()*90000);return letter+number;}
function updateReferralUI(){document.getElementById('refCode').innerText=userRefCode||'--';}
function updateTicketCountUI(){if(!currentUser)return;db.ref('raffleTickets').orderByChild('owner').equalTo(currentUser).on('value',snap=>{const tickets=snap.val()||{};document.getElementById('ticketCount').innerText=Object.keys(tickets).length;});}

// --- Create account ---
document.getElementById('createCodeBtn').onclick=()=>{
  const code='user-'+Math.random().toString(36).substr(2,6);
  const refCode=generateReferralCode();
  db.ref('users/'+code).set({created:Date.now(),referralCode:refCode});
  alert('Your code: '+code);
  document.getElementById('loginCode').value=code;
};

// --- Login ---
document.getElementById('loginBtn').onclick=()=>{
  const code=document.getElementById('loginCode').value.trim();
  if(!code)return alert('Enter a code');
  db.ref('users/'+code).once('value').then(snapshot=>{
    const user=snapshot.val();
    if(!user)return alert('Invalid code');
    currentUser=code;
    currentUserIsAdmin=(code==='user-9e21mr');
    document.getElementById('acctCode').innerText=code;
    userRefCode=user.referralCode||generateReferralCode();
    if(!user.referralCode)db.ref('users/'+code+'/referralCode').set(userRefCode);
    updateReferralUI();
    document.getElementById('loginModal').classList.add('hidden');
    if(currentUserIsAdmin)document.getElementById('adminScreen').style.display='block';
    document.getElementById('warningModal').classList.toggle('hidden',currentUserIsAdmin);
    updateTicketCountUI();
    renderTickets();
    renderProducts();
  });
};

// --- Warning confirm ---
document.getElementById('ackBtn').onclick=()=>{
  if(!document.getElementById('ackCheck').checked)return alert('Check agree');
  document.getElementById('warningModal').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
};

// --- Logout & clear ---
document.getElementById('logoutBtn').onclick=()=>location.reload();
document.getElementById('clearBtn').onclick=()=>{cart=[];renderCart();};

// --- Products & Cart ---
function renderProducts(){
  const grid=document.getElementById('productsGrid');grid.innerHTML='';
  const sample=[
    {id:'bud1',name:'Edibles (Buy 3 get 1 free)',price:20,flavors:['Sour Patch','Skittles','Swedish fish','Watermelon Sour Patch','Starburst','Trolli','Peach Rings']},
    {id:'cart1',name:'2g Muha Meds Carts (Buy 1 get 1 $5 off)',price:30,flavors:['Sugar Daddy Punch','Pineapple Runtz','Blueberry Muffin','Blue Slushie','Candy Apple']}
  ];
  sample.forEach(p=>{
    const div=document.createElement('div');div.className='product';
    const title=document.createElement('h3');title.textContent=p.name;
    const priceDiv=document.createElement('div');priceDiv.textContent='$'+p.price;
    const select=document.createElement('select');const defOpt=document.createElement('option');defOpt.value='';defOpt.textContent='Select Flavor';select.appendChild(defOpt);
    p.flavors.forEach(f=>{const option=document.createElement('option');option.value=f;option.textContent=f;select.appendChild(option);});
    const btn=document.createElement('button');btn.className='btn';btn.textContent='Add';
    btn.onclick=()=>{const flavor=select.value||'None';if(!flavor)return alert('Select a flavor');cart.push({...p,selectedFlavor:flavor});renderCart();};
    div.appendChild(title);div.appendChild(priceDiv);div.appendChild(select);div.appendChild(btn);grid.appendChild(div);
  });
}
function renderCart(){
  const list=document.getElementById('cartList');list.innerHTML='';let total=0,ediblesCount=0,muhaCount=0;
  cart.forEach(c=>{if(c.name.includes('Edibles'))ediblesCount++;if(c.name.includes('Muha Meds'))muhaCount++;total+=c.price;});
  total-=Math.floor(ediblesCount/4)*20;total-=Math.floor(muhaCount/2)*5;
  document.getElementById('cartTotal').innerText='Total: $'+total;
  cart.forEach((c,i)=>{
    const div=document.createElement('div');div.className='cart-item';
    div.textContent=c.name+' ('+c.selectedFlavor+') $'+c.price;
    const rem=document.createElement('button');rem.className='btn ghost';rem.textContent='X';rem.onclick=()=>{cart.splice(i,1);renderCart();};
    div.appendChild(rem);list.appendChild(div);
  });
}

// --- Purchase ticket ---
document.getElementById('purchaseBtn').onclick=()=>{
  if(cart.length===0)return alert('Cart empty');
  const ticketId='ticket-'+Date.now();
  const ticket={id:ticketId,owner:currentUser,cart,location:document.getElementById('locationSelect').value,status:'pending',messages:[]};
  db.ref('raffleTickets/'+ticketId).set(ticket);
  cart=[];renderCart();updateTicketCountUI();renderTickets();
};

// --- Tickets area ---
function renderTickets(){
  const area=document.getElementById('ticketsArea');area.innerHTML='';
  db.ref('raffleTickets').orderByChild('owner').equalTo(currentUser).once('value').then(snap=>{
    const tickets=snap.val()||{};
    Object.values(tickets).forEach(t=>{
      const div=document.createElement('div');div.className='ticket';
      div.innerHTML=`<strong>${t.id}</strong> Status: ${t.status} Location: ${t.location}`;
      area.appendChild(div);
    });
  });
}

// --- Admin screen WINNER ---
document.getElementById('winnerBtn').onclick=()=>{
  const winnerId='winner-'+Date.now();
  db.ref('winnerTickets/'+winnerId).set({id:winnerId,status:'winner',user:'',messages:[]});
  alert('Winner ticket created');
};

// --- Refresh tickets admin ---
document.getElementById('refreshTickets').onclick=()=>{alert('Admin refresh placeholder');};
document.getElementById('closeAdmin').onclick=()=>document.getElementById('adminScreen').style.display='none';
</script>
</body>
</html>
